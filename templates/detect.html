<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skin Check</title>
  <style>
  :root{
    --bg1:#1e2a38; --bg2:#28364a; 
    --panel:#0f1420ee; --panel-2:#121a29; 
    --text:#eef3ff; --muted:#a7b0c7;
    --brand:#67b3ff; --brand-2:#a48bff;
    --accent:#41e0a4; --danger:#ff6b6b;
    --border:#243048;

    --radius:16px; --radius-sm:12px;
    --shadow:0 14px 40px rgba(0,0,0,.35);
    --grad:linear-gradient(135deg,var(--brand),var(--brand-2));
  }

  *{box-sizing:border-box}
  html,body{height:100%}


  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 800px at 15% -10%, #334667 0%, transparent 60%),
      radial-gradient(1400px 900px at 120% 110%, #1a2742 0%, transparent 65%),
      linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, "Noto Sans", sans-serif;
    min-height:100svh; overflow-x:hidden;
  }


  body::before{
    content:"";
    position:fixed; inset:-10% -10%;
    pointer-events:none; z-index:0;
    background:
      radial-gradient(40% 35% at 20% 25%, rgba(103,179,255,.28), transparent 60%),
      radial-gradient(45% 40% at 80% 20%, rgba(164,139,255,.25), transparent 60%),
      radial-gradient(38% 32% at 55% 75%, rgba(65,224,164,.22), transparent 60%);
    filter: blur(30px) saturate(1.1);
    animation: floatAurora 20s ease-in-out infinite;
    transform: translateZ(0);
    mix-blend-mode: screen;
  }
  @keyframes floatAurora{
    0%   { transform: translate(-1%, -1%) scale(1.00) }
    50%  { transform: translate(1%, 1%)   scale(1.04) }
    100% { transform: translate(-1%, -1%) scale(1.00) }
  }


  body::after{
    content:"";
    position:fixed; inset:0; pointer-events:none; z-index:0;
    background: repeating-linear-gradient(60deg, rgba(255,255,255,.05) 0 2px, transparent 2px 18px);
    opacity:.28; mix-blend-mode: overlay;
    animation: drift 24s linear infinite;
  }
  @keyframes drift{ 0%{background-position:0 0} 100%{background-position:320px 220px} }

  .wrap{position:relative; z-index:1; max-width:1120px; margin:auto; padding:28px 18px 90px}
  header{display:flex; align-items:center; gap:14px; margin-bottom:16px}
  .mark{width:46px; height:46px; border-radius:14px; background:var(--grad); display:grid; place-items:center;
        box-shadow:var(--shadow); color:#0b0f18; font-weight:900}
  header h1{margin:0; font-size:1.55rem}
  header .sub{color:var(--muted)}

  .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:18px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)), var(--panel);
    border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow);
    backdrop-filter: blur(6px)
  }
  .card h2{margin:0 0 12px; font-size:1.06rem}

  .uploader{border:1.5px dashed #344563; border-radius:var(--radius); padding:18px; display:grid; place-items:center; text-align:center; transition:.25s}
  .uploader.drag{border-color:#89b1ff; background:#0e1530}
  .uploader input{display:none}
  .cta{display:inline-flex; align-items:center; gap:8px; background:var(--grad); padding:10px 14px; border:none; color:#0b0f18; border-radius:14px; cursor:pointer; font-weight:800}
  .hint{color:var(--muted); font-size:.92rem; margin-top:8px}

  .preview{display:none; margin-top:14px; gap:14px; align-items:flex-start}
  .preview img{width:168px; height:168px; object-fit:cover; border-radius:14px; border:1px solid var(--border)}
  .kv{display:flex; gap:8px; flex-wrap:wrap}
  .tag{background:#141c2d; border:1px solid var(--border); padding:6px 9px; border-radius:999px; color:#d6def2; font-size:.88rem}

  .btn{appearance:none; border:none; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer}
  .btn.primary{background:var(--grad); color:#0b0f18}
  .btn.secondary{background:#121a2a; color:#d6def2; border:1px solid var(--border)}
  .btn.ghost{background:transparent; border:1px dashed #344563; color:#cfd6ea}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

  textarea{width:100%; min-height:140px; resize:vertical; background:var(--panel-2); color:var(--text);
           border:1px solid var(--border); border-radius:var(--radius-sm); padding:12px; line-height:1.6}

 
  .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:.88rem;
        border:1px solid var(--border); background:#101726}
  .skeleton{height:8px; border-radius:10px; background:
      linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.18), rgba(255,255,255,.08));
      background-size:300% 100%; animation: shimmer 1.2s infinite}
  @keyframes shimmer{0%{background-position:0 0} 100%{background-position:300% 0}}
  .skeleton::before{content:""; display:block; height:100px; margin-bottom:10px}
  .skeleton::after{content:""; display:block; height:16px; margin-top:10px}

  .overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); z-index:50}
  .overlay.show{display:grid}
  .dialog{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px 16px; display:flex; align-items:center; gap:12px; box-shadow:var(--shadow)}
  .spinner{width:22px; height:22px; border-radius:50%; border:3px solid #263044; border-top-color:#7aa2ff; animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .toast{position:fixed; right:16px; bottom:16px; background:#10131a; border:1px solid var(--border); color:var(--text);
         padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(10px); transition:.25s; z-index:60}
  .toast.show{opacity:1; transform:translateY(0)}

  /* Analyze button loading state */
  .btn.loading{ position:relative; pointer-events:none; opacity:.88 }
  .btn.loading::after{
    content:""; width:16px; height:16px; border-radius:50%;
    border:2px solid currentColor; border-top-color:transparent;
    position:absolute; right:12px; top:50%; transform:translateY(-50%);
    animation:spin 1s linear infinite;
  }
  </style>

</head>
<body>
  <div class="wrap">
    <header>
      <div class="mark">🧪</div>
      <div>
        <h1>Skin Check</h1>
        <div class="sub">Upload an image, add symptoms (optional), and get an AI explanation.</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <h2>Input</h2>

        <div id="drop" class="uploader" tabindex="0">
          <div>
            <p style="margin:6px 0 10px">Drag & drop an image here</p>
            <button class="cta" id="pickBtn" type="button">Choose File</button>
            <div class="hint">PNG/JPG up to ~10 MB</div>
          </div>
          <input id="fileInput" name="file" type="file" accept="image/*" />
        </div>

        <div id="preview" class="preview">
          <img id="prevImg" alt="preview"/>
          <div style="flex:1">
            <div class="kv" style="margin-bottom:10px">
              <span class="tag" id="kvName">—</span>
              <span class="tag" id="kvSize">—</span>
              <span class="tag" id="kvDim">—</span>
            </div>
            <div class="row">
              <button class="btn secondary" id="replaceBtn" type="button">Replace</button>
              <button class="btn ghost" id="clearBtn" type="button">Clear</button>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>
        <h2>Symptoms (optional)</h2>
        <textarea id="symptom" name="symptom" placeholder="e.g., redness, itchiness, sensitivity..."></textarea>
        <div class="row" style="justify-content:space-between">
          <div class="chars"><span id="charCount">0</span> / 600</div>
          <div class="row">
            <button id="tryBtn" class="btn secondary" type="button">Try sample</button>
            <button id="analyzeBtn" class="btn primary" type="button" disabled>Analyze</button>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <h2>Result</h2>
        <div id="meta" class="meta" style="display:none">
          <span class="chip" id="chipMode">Mode: —</span>
          <span class="chip" id="chipTime">—</span>
        </div>

        <div id="empty" class="muted">No analysis yet.</div>
        <div id="loading" class="skeleton" style="display:none"></div>

        <div id="explanationWrap" style="display:none">
          <div id="explanation"></div>
          <div class="disclaimer" style="margin-top:10px; color:var(--muted)">
            This content is general, non-diagnostic information. If symptoms persist, worsen, or spread, seek a clinician’s evaluation.
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn secondary" id="resetBtn" type="button">Reset</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="overlay" class="overlay">
    <div class="dialog"><div class="spinner"></div><div>Processing…</div></div>
  </div>
  <div id="toast" class="toast"></div>

  <script>
  (function(){
    'use strict';
    const $ = id => document.getElementById(id);

 
    const drop = $('drop'), fileInput = $('fileInput'), pickBtn = $('pickBtn');
    const preview = $('preview'), prevImg = $('prevImg'), kvName = $('kvName'), kvSize = $('kvSize'), kvDim = $('kvDim');
    const replaceBtn = $('replaceBtn'), clearBtn = $('clearBtn');
    const symptom = $('symptom'), charCount = $('charCount');
    const tryBtn = $('tryBtn'), analyzeBtn = $('analyzeBtn'), resetBtn = $('resetBtn');
    const overlay = $('overlay'), toastBox = $('toast');
    const empty = $('empty'), loading = $('loading'), explanationWrap = $('explanationWrap'), explanation = $('explanation');
    const meta = $('meta'), chipMode = $('chipMode'), chipTime = $('chipTime');

  
    function toast(msg){ toastBox.textContent = msg; toastBox.classList.add('show'); setTimeout(()=>toastBox.classList.remove('show'), 2200); }
    function bytes(n){ const u=['B','KB','MB','GB']; let i=0,v=n; while(v>1024&&i<u.length-1){v/=1024;i++} return (i?v.toFixed(1):v|0)+' '+u[i]; }
    function updateAnalyzeState(){
      const hasFile = !!(fileInput.files && fileInput.files[0]);
      const hasTxt = (symptom.value || '').trim().length > 0;
      analyzeBtn.disabled = !(hasFile || hasTxt) || analyzeBtn.classList.contains('loading');
    }
    function setProcessing(on){
      if(on){
        analyzeBtn.dataset.prevLabel = analyzeBtn.textContent || 'Analyze';
        analyzeBtn.textContent = 'Processing…';
        analyzeBtn.classList.add('loading');
        analyzeBtn.disabled = true;
        overlay.classList.add('show');
      }else{
        analyzeBtn.textContent = analyzeBtn.dataset.prevLabel || 'Analyze';
        analyzeBtn.classList.remove('loading');
        overlay.classList.remove('show');
        updateAnalyzeState();
      }
    }

    // Image preview
    pickBtn.addEventListener('click', ()=> fileInput.click());
    replaceBtn.addEventListener('click', ()=> fileInput.click());
    clearBtn.addEventListener('click', ()=> { fileInput.value=''; preview.style.display='none'; updateAnalyzeState(); });

    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f){ updateAnalyzeState(); return; }
      if(!/^image\//.test(f.type)){ toast('Please select an image file.'); fileInput.value=''; updateAnalyzeState(); return; }
      if(f.size > 10*1024*1024){ toast('File too large (>10MB)'); fileInput.value=''; updateAnalyzeState(); return; }
      const url = URL.createObjectURL(f);
      prevImg.onload = ()=>{ URL.revokeObjectURL(url); kvDim.textContent = `${prevImg.naturalWidth}×${prevImg.naturalHeight}`; };
      prevImg.src = url;
      kvName.textContent = f.name;
      kvSize.textContent = bytes(f.size);
      preview.style.display='grid';
      updateAnalyzeState();
    });

    // Drag & drop
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.add('drag');}));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.remove('drag');}));
    drop.addEventListener('drop', e=>{
      const f = e.dataTransfer.files[0]; if(!f) return;
      fileInput.files = e.dataTransfer.files; fileInput.dispatchEvent(new Event('change'));
    });

    // Symptom box
    const MAX_LEN = 600;
    symptom.addEventListener('input', ()=>{
      const val = symptom.value;
      if(val.length > MAX_LEN){ symptom.value = val.slice(0, MAX_LEN); }
      charCount.textContent = symptom.value.length;
      updateAnalyzeState();
    });
    charCount.textContent = 0;

    tryBtn.addEventListener('click', ()=>{
      symptom.value = 'red, scaly plaques on elbows for weeks; intermittent itch; gets worse after cold weather';
      charCount.textContent = symptom.value.length;
      updateAnalyzeState();
      toast('Sample text inserted.');
    });

    // Text cleanup
    function cleanupModelText(s){
      let t = String(s || '');
      t = t.replace(/\bimage[- ]based\s+description\s*(?:\(\s*non[- ]diagnostic\s*\))?\s*:\s*/gi,'')
           .replace(/\bderm[- ]?focused\s+visual\s+description\s*:\s*/gi,'');
      t = t.split(/\r?\n/).filter(line => !/^\s*(no|none|null|n\/a)\s*$/i.test(line)).join(' ');
      t = t.replace(/\s{2,}/g,' ').trim();
      return t;
    }
    function finishSentence(s){
      let t = (s||'').trim(); if(!t) return t;
      if(/[.!?…]\s*$/.test(t)) return t;
      if(/(?:\b(?:and|or|with|including|such as|like)|[,;:])\s*$/.test(t)){
        t += ' Consider gentle skincare and sun protection, and consult a clinician if symptoms persist or worsen.';
      } else t += '.';
      return t;
    }
    function inferDiagnosisFromText(txt){
      const t = String(txt||'').toLowerCase();
      if(/\bpsoriasis\b/.test(t)) return 'psoriasis-like pattern';
      if(/\beczema|dermatitis\b/.test(t)) return 'eczema-like pattern';
      if(/\bacne|pimple|comedone\b/.test(t)) return 'acne-like pattern';
      if(/\bfungal|tinea|ringworm\b/.test(t)) return 'tinea-like pattern';
      if(/\bhives|urticaria\b/.test(t)) return 'urticaria-like pattern';
      if(/\berythema|red(?:ness)?\b/.test(t)) return 'erythema-like pattern';
      return null;
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }

    // Analyze
    analyzeBtn.addEventListener('click', async ()=>{
      const f = fileInput.files[0];
      const hasTxt = (symptom.value || '').trim().length > 0;
      if(!f && !hasTxt){ toast('Please add a photo or write symptoms.'); return; }

      const fd = new FormData();
      if(f) fd.append('file', f);
      fd.append('symptom', symptom.value || '');
      fd.append('length', 'long');

      const t0 = performance.now();
      empty.style.display='none';
      explanationWrap.style.display='none';
      meta.style.display='none';
      loading.style.display='block';
      setProcessing(true);

      try{
        const res = await fetch('/detect', { method:'POST', body:fd });
        const raw = await res.text();
        if(!res.ok){
          let msg = raw; try{ msg = JSON.parse(raw).message || msg }catch{}
          throw new Error(msg);
        }
        const data = JSON.parse(raw);

        const hadFile = !!f;
        let body = cleanupModelText(data.symptom_analysis || '');
        body = finishSentence(body);

        const dx = (data.disease && String(data.disease).trim()) || inferDiagnosisFromText(body);
        const parts = [];
        if(hadFile && dx){
          parts.push(`From the picture you uploaded, it seems like <strong>${escapeHtml(dx)}</strong>.`);
        }
        if(hasTxt){
          const u = (symptom.value || '').trim();
          if(u) parts.push(`Based on your notes (“${escapeHtml(u)}”), here is a combined, non-diagnostic explanation:`);
        }
        if(body) parts.push(escapeHtml(body));
        if(parts.length===0) parts.push('No explanation was generated.');

        explanation.innerHTML = '<p>'+ parts.join(' ') +'</p>';

        chipMode.textContent = 'Mode: ' + (hadFile && hasTxt ? 'Image + Text' : hadFile ? 'Image only' : 'Text only');
        const ms = Math.max(1, Math.round(performance.now() - t0));
        chipTime.textContent = `Processed in ${(ms/1000).toFixed(2)}s`;
        meta.style.display='flex';

        loading.style.display='none';
        explanationWrap.style.display='block';
      } catch (err){
        loading.style.display='none';
        empty.style.display='block';
        toast('Error: ' + err.message);
      } finally{
        setProcessing(false);
      }
    });

    resetBtn.addEventListener('click', ()=>{
      fileInput.value=''; preview.style.display='none';
      symptom.value=''; charCount.textContent='0';
      empty.style.display='block'; loading.style.display='none';
      explanationWrap.style.display='none'; meta.style.display='none';
      updateAnalyzeState();
    });

    
    updateAnalyzeState();
  })();
  </script>
</body>
</html>
